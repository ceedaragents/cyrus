# cyrus-cloudflare-tunnel-client

Cloudflare tunnel client for receiving configuration updates and Linear webhooks from cyrus-hosted.

## Overview

This package provides a transport client that uses Cloudflare tunnels to receive:
- Configuration updates from the Cyrus hosted service
- Linear webhook payloads forwarded through cyrus-hosted
- Repository management requests (clone/verify repositories)
- GitHub credential updates
- MCP server configuration

## Features

- **Customer ID Authentication**: Validates subscription status with cyrus-hosted
- **Cloudflare Tunnel**: Automatic tunnel setup using cloudflared binary
- **HTTP Server**: Handles incoming requests for config updates and webhooks
- **API Key Authentication**: Secures all incoming requests
- **Error Handling**: Reports errors back to cyrus-hosted

## Installation

```bash
npm install cyrus-cloudflare-tunnel-client
```

## Usage

```typescript
import { CloudflareTunnelClient } from 'cyrus-cloudflare-tunnel-client';

const client = new CloudflareTunnelClient({
  customerId: 'cus_xxxxx',
  cyrusHome: '/Users/you/.cyrus',
  onWebhook: (payload) => {
    console.log('Received webhook:', payload);
  },
  onConfigUpdate: () => {
    console.log('Configuration updated');
  },
  onReady: (tunnelUrl) => {
    console.log('Tunnel ready:', tunnelUrl);
  },
  onError: (error) => {
    console.error('Error:', error);
  },
});

// Authenticate and start tunnel
await client.authenticate();

// Wait for onReady event with tunnel URL
// Tunnel is now ready to receive requests from cyrus-hosted
```

## API Endpoints

The client exposes these endpoints for cyrus-hosted to call:

### `/api/github-credential`
Update GitHub CLI authentication.

### `/api/cyrus-config`
Update `~/.cyrus/config.json` with repository configurations.

### `/api/cyrus-env`
Update `~/.cyrus/.env` (primarily for Claude API token).

### `/api/repository`
Clone or verify a repository at a specified path.

### `/api/test-mcp`
Test MCP server connectivity (placeholder implementation).

### `/api/configure-mcp`
Write MCP configuration files to `~/.cyrus/mcp-{slug}.json`.

### `/webhook`
Receive Linear webhook payloads.

## Authentication Flow

1. Client calls subscription API with customer ID
2. API validates subscription and returns:
   - `cloudflareToken`: For tunnel setup
   - `apiKey`: For authenticating incoming requests
3. Client starts Cloudflare tunnel
4. Client listens for authenticated requests from cyrus-hosted

## Security

- All requests must include `Authorization: Bearer {apiKey}` header
- API key is generated by cyrus-hosted and returned during authentication
- Cloudflare tunnel provides encrypted connection
- All file operations are restricted to `~/.cyrus` directory

## Development

```bash
# Install dependencies
pnpm install

# Build
pnpm build

# Run tests
pnpm test

# Type check
pnpm typecheck
```

## License

MIT
