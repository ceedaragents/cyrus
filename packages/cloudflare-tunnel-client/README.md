# cyrus-cloudflare-tunnel-client

Cloudflare tunnel client for receiving configuration updates and Linear webhooks from cyrus-hosted.

## Overview

This package provides a transport client that uses Cloudflare tunnels to receive:
- Configuration updates from the Cyrus hosted service
- Linear webhook payloads forwarded through cyrus-hosted
- Repository management requests (clone/verify repositories to `~/.cyrus/repos`)
- MCP server configuration

## Features

- **Customer ID Authentication**: Validates subscription status with cyrus-hosted
- **Cloudflare Tunnel**: Automatic tunnel setup using cloudflared binary
- **HTTP Server**: Handles incoming requests for config updates and webhooks
- **API Key Authentication**: Secures all incoming requests
- **Error Handling**: Reports errors back to cyrus-hosted

## Installation

```bash
npm install cyrus-cloudflare-tunnel-client
```

## Usage

```typescript
import { CloudflareTunnelClient } from 'cyrus-cloudflare-tunnel-client';

const client = new CloudflareTunnelClient({
  authKey: 'xxx_your_auth_key_from_onboarding',
  cyrusHome: '/Users/you/.cyrus',
  onWebhook: (payload) => {
    console.log('Received webhook:', payload);
  },
  onConfigUpdate: () => {
    console.log('Configuration updated');
  },
  onReady: (tunnelUrl) => {
    console.log('Tunnel ready:', tunnelUrl);
  },
  onError: (error) => {
    console.error('Error:', error);
  },
});

// Authenticate and start tunnel
await client.authenticate();

// Wait for onReady event with tunnel URL
// Tunnel is now ready to receive requests from cyrus-hosted
```

## API Endpoints

The client exposes these endpoints for cyrus-hosted to call:

### `/api/update/cyrus-config`
Update `~/.cyrus/config.json` with repository configurations. Supports optional `restartCyrus` and `backupConfig` flags.

### `/api/update/cyrus-env`
Update `~/.cyrus/.env` (primarily for Claude API token). Supports optional `restartCyrus` and `backupEnv` flags.

### `/api/update/repository`
Clone or verify a repository to `~/.cyrus/repos/<repo-name>`. Expects `repository_url` and `repository_name` in payload.

### `/api/test-mcp`
Test MCP server connectivity (placeholder for future implementation).

### `/api/configure-mcp`
Write MCP configuration files to `~/.cyrus/mcp-{slug}.json`.

### `/webhook`
Receive Linear webhook payloads forwarded from cyrus-hosted.

## Authentication Flow

1. User completes Pro plan checkout on cyrus-hosted
2. cyrus-hosted generates auth key and displays it in onboarding UI
3. User runs `cyrus auth <auth_key>` in CLI
4. Client calls `/api/config?auth_key=xxx` on cyrus-hosted
5. API validates auth key and returns:
   - `cloudflareToken`: For tunnel setup
   - `apiKey`: For authenticating incoming requests from cyrus-hosted
6. Client starts Cloudflare tunnel with token
7. Client listens for authenticated requests from cyrus-hosted

## Security

- All requests must include `Authorization: Bearer {apiKey}` header
- API key is generated by cyrus-hosted and returned during authentication
- Cloudflare tunnel provides encrypted connection
- All file operations are restricted to `~/.cyrus` directory

## Development

```bash
# Install dependencies
pnpm install

# Build
pnpm build

# Run tests
pnpm test

# Type check
pnpm typecheck
```

## License

MIT
